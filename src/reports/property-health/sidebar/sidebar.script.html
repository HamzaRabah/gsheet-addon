<script>
  new Vue({
      el: '#app',

      data() {
        return {
          context: apaleoContext,
          user: undefined,
          properties: [],
          selectedProperty: undefined,
          inProgress: false
        }
      },
      methods: {
        signIn() {
          scriptService
            .getAuthorizationUrl()
            .then((url) => window.open(url))
            .catch((e) => this.onError(e));
        },

        signOut() {
          scriptService
            .signOut()
            .then(() => this.context.isSignedIn = false);
        },

        init() {
          this.inProgress = true;

          (this.context.isCustomApp
             ? Promise.resolve({ isCustomApp: true })
             : scriptService.getCurrentUserInfo()
          ).then((user) => {
              this.user = user;

              return scriptService.getPropertyList();
            })
            .then((data) => {
              this.properties = this.user && (
                (this.user.isAccountAdmin || this.user.isCustomApp)
                   ? data
                   : data.filter(p => this.user.properties.indexOf(p.code) != -1)
              ) || [];

              this.inProgress = false;
            })
            .catch((e) => this.onError(e));
        },

        submit() {
          const property = this.selectedProperty;
          this.inProgress = true;

          scriptService
            .generatePropertyHealthReport(property)
            .then(() => this.inProgress = false)
            .catch((e) => this.onError(e));
        },

        onError(error) {
          if (error) {
            scriptService.alert(error.message);
          }

          this.inProgress = false;
        }
      },
      mounted() {
        Intercom.getInstance().on('oauthComplete', (data) => {
            this.context.isSignedIn = data.isSignedIn;
            this.init();
        });

        if (this.context.isSignedIn) {
          this.init();
        }
      }
  });
</script>